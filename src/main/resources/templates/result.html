<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/header :: head(${title}, ${metaDescription}, ${canonicalUrl}, ${ogTitle}, ${ogDescription}, ${ogUrl}, ${ogImageUrl})}"></head>
<body>
<div class="page-container">
    <!-- Top Header -->
    <header class="page-header">
        <div class="header-content">
            <a href="/" class="logo">OfferVerdict</a>
            <button class="btn-edit-inputs" id="editInputsBtn" aria-label="Edit inputs">
                <span>‚úèÔ∏è</span> Edit Inputs
            </button>
        </div>
    </header>

    <!-- Edit Inputs Accordion -->
    <div class="edit-panel" id="editPanel">
        <div class="edit-panel-content">
            <form th:action="@{/}" method="get">
                <input type="hidden" name="job" th:value="${job.slug}"/>
                <div class="edit-grid">
                    <div class="input-group">
                        <label class="input-label">Current salary</label>
                        <input type="number" name="currentSalary" class="minimal-input" min="1000" max="10000000" step="1" th:value="${currentSalary}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Offer salary</label>
                        <input type="number" name="offerSalary" class="minimal-input" min="1000" max="10000000" step="1" th:value="${offerSalary}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Current city</label>
                        <input name="cityA" class="minimal-input" list="city-options" th:value="${cityA.slug}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Offer city</label>
                        <input name="cityB" class="minimal-input" list="city-options" th:value="${cityB.slug}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Household</label>
                        <select name="householdType" class="minimal-select" th:value="${householdType}">
                            <option value="SINGLE" th:selected="${householdType.name() == 'SINGLE'}">Single</option>
                            <option value="FAMILY" th:selected="${householdType.name() == 'FAMILY'}">Family</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Housing</label>
                        <select name="housingType" class="minimal-select" th:value="${housingType}">
                            <option value="RENT" th:selected="${housingType.name() == 'RENT'}">Renting</option>
                            <option value="OWN" th:selected="${housingType.name() == 'OWN'}">Own home</option>
                            <option value="PARENTS" th:selected="${housingType.name() == 'PARENTS'}">Living with parents</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <button type="submit" class="btn btn-primary btn-full">Update verdict</button>
                    </div>
                </div>
            </form>
            <datalist id="city-options">
                <option th:each="city : ${cities}" th:value="${city.slug}" th:text="|${city.city}, ${city.state}|"></option>
            </datalist>
        </div>
    </div>

    <div th:if="${validationMessage}" class="validation-message">
        <strong>Check your numbers.</strong>
        <span th:text="${validationMessage}">Please enter a realistic salary.</span>
    </div>

    <!-- Main Content: Top-Down Layout -->
    <main class="main-content">
        <!-- Hero Verdict Section (Top Center) -->
        <section class="verdict-hero" th:classappend="'verdict-' + ${result.verdict.name().toLowerCase().replace('_','-')}" id="verdictHero">
            <div class="verdict-hero-content">
                <p class="verdict-route" th:text="|${cityA.city}, ${cityA.state} ‚Üí ${cityB.city}, ${cityB.state}|">Route</p>
                <div class="verdict-badge-container">
                    <h1 class="verdict-badge" id="verdictBadge" th:text="${result.verdict}">GO</h1>
                    <!-- Quick Correction Toggles -->
                    <div class="quick-correction-toggles">
                        <label class="correction-toggle">
                            <input type="checkbox" id="ownHomeToggle"/>
                            <span class="toggle-switch"></span>
                            <span class="toggle-text">I Own a Home</span>
                        </label>
                        <label class="correction-toggle">
                            <input type="checkbox" id="parentsToggle"/>
                            <span class="toggle-switch"></span>
                            <span class="toggle-text">Living with Parents</span>
                        </label>
                        <label class="correction-toggle">
                            <input type="checkbox" id="splitRentToggle"/>
                            <span class="toggle-switch"></span>
                            <span class="toggle-text">Split Rent (Partner)</span>
                        </label>
                    </div>
                </div>
                <p class="verdict-copy" id="verdictCopy" th:text="${result.verdictCopy}">Punchy copy</p>
                
                <div class="verdict-metrics">
                    <div class="metric-item">
                        <div class="metric-label">Monthly Residual</div>
                        <div class="metric-value" id="heroResidualValue">
                            <span class="rolling-number tabular-nums" 
                                  th:attr="data-target=${#numbers.formatDecimal(result.offer.residual, 1, 0)}" 
                                  data-prefix="$"
                                  th:text="${'$' + #numbers.formatDecimal(result.offer.residual, 1, 0)}">$0</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">vs Current</div>
                        <div class="metric-value">
                            <span class="rolling-number tabular-nums delta-percent" id="deltaPercentValue"
                                  th:attr="data-target=${#numbers.formatDecimal(result.deltaPercent, 1, 1)}"
                                  th:text="|${#numbers.formatDecimal(result.deltaPercent, 1, 1)}%|">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Life Simulator Section -->
        <section class="simulator-section" id="lifeSimulator">
            <div class="section-header">
                <h2>üõ†Ô∏è Can I survive there?</h2>
                <p class="section-subtitle">Adjust your lifestyle to see if you can make it work</p>
            </div>

            <div class="simulator-controls">
                <!-- Housing Controls -->
                <div class="control-group">
                    <label class="control-label">Housing</label>
                    <div class="control-inputs">
                        <div class="slider-control">
                            <label>Monthly Rent</label>
                            <div class="slider-wrapper">
                                <input type="range" id="rentSlider" 
                                       th:attr="data-base=${result.offer.rent}"
                                       min="0" max="10000" step="50" 
                                       th:value="${result.offer.rent}"/>
                                <span class="slider-value" id="rentValue" th:text="${'$' + #numbers.formatDecimal(result.offer.rent, 1, 0)}">$0</span>
                            </div>
                        </div>
                        <div class="toggle-control">
                            <label class="toggle-label">
                                <input type="checkbox" id="roommateToggle"/>
                                <span class="toggle-slider"></span>
                                <span class="toggle-text">Roommate (-40% rent)</span>
                            </label>
                        </div>
                        <div class="toggle-control">
                            <label class="toggle-label">
                                <input type="checkbox" id="parentsToggle"/>
                                <span class="toggle-slider"></span>
                                <span class="toggle-text">Live with Parents ($0 rent, +$200 social cost)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Transport Controls -->
                <div class="control-group">
                    <label class="control-label">Transport</label>
                    <div class="control-inputs">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="transport" value="car" id="transportCar" checked/>
                                <span>Car Owner (Default)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="transport" value="transit" id="transportTransit"/>
                                <span>Public Transit Only (Save gas/insurance, Add pass cost)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Dining Controls -->
                <div class="control-group">
                    <label class="control-label">Dining</label>
                    <div class="control-inputs">
                        <div class="slider-control">
                            <label>Home Cook ‚Üî Foodie</label>
                            <div class="slider-wrapper">
                                <input type="range" id="diningSlider" min="0" max="100" step="5" value="50"/>
                                <span class="slider-value" id="diningValue">50%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Simulator Result -->
            <div class="simulator-result" id="simulatorResult">
                <div class="result-preview">
                    <div class="preview-label">New Residual</div>
                    <div class="preview-value" id="newResidualValue">$0</div>
                    <div class="preview-verdict" id="newVerdictBadge"></div>
                </div>
            </div>
        </section>

        <!-- Evidence Section: Waterfall Chart -->
        <section class="evidence-section">
            <h2 class="section-title">The Numbers</h2>
            <div class="waterfall-chart" id="waterfallChart">
                <div class="waterfall-item">
                    <div class="waterfall-label">Gross Income</div>
                    <div class="waterfall-bar waterfall-positive" id="waterfallGross" 
                         th:attr="data-value=${result.offer.netMonthly * 12 / (1 - 0.0765)}"
                         style="height: 100%">
                        <span class="waterfall-value" id="waterfallGrossValue" 
                              th:text="${'$' + #numbers.formatDecimal(result.offer.netMonthly * 12 / (1 - 0.0765), 1, 0)}">$0</span>
                    </div>
                </div>
                <div class="waterfall-item">
                    <div class="waterfall-label">(-) Taxes</div>
                    <div class="waterfall-bar waterfall-negative" id="waterfallTaxes"
                         th:attr="data-value=${(result.offer.netMonthly * 12 / (1 - 0.0765)) - (result.offer.netMonthly * 12)}"
                         style="height: 0%">
                        <span class="waterfall-value" id="waterfallTaxesValue"
                              th:text="${'$' + #numbers.formatDecimal((result.offer.netMonthly * 12 / (1 - 0.0765)) - (result.offer.netMonthly * 12), 1, 0)}">$0</span>
                    </div>
                </div>
                <div class="waterfall-item">
                    <div class="waterfall-label">(-) Housing</div>
                    <div class="waterfall-bar waterfall-negative" id="waterfallHousing"
                         th:attr="data-value=${result.offer.rent}"
                         style="height: 0%">
                        <span class="waterfall-value" id="waterfallHousingValue"
                              th:text="${'$' + #numbers.formatDecimal(result.offer.rent, 1, 0)}">$0</span>
                    </div>
                </div>
                <div class="waterfall-item">
                    <div class="waterfall-label">(=) Residual</div>
                    <div class="waterfall-bar waterfall-positive" id="waterfallResidual"
                         th:attr="data-value=${result.offer.residual}"
                         style="height: 0%">
                        <span class="waterfall-value" id="waterfallResidualValue"
                              th:text="${'$' + #numbers.formatDecimal(result.offer.residual, 1, 0)}">$0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lifestyle Multiplier -->
        <section class="lifestyle-section">
            <h2 class="section-title">What that money really means</h2>
            <div class="lifestyle-scroll">
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">‚òï</div>
                    <div class="lifestyle-value tabular-nums" th:text="${#numbers.formatDecimal(result.offerLifestyle.starbucksCoffees, 0, 0)}">0</div>
                    <div class="lifestyle-label">Starbucks</div>
                </div>
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">üì∫</div>
                    <div class="lifestyle-value tabular-nums" th:text="${#numbers.formatDecimal(result.offerLifestyle.netflixSubscriptions, 0, 0)}">0</div>
                    <div class="lifestyle-label">Netflix</div>
                </div>
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">üçî</div>
                    <div class="lifestyle-value tabular-nums" th:text="${#numbers.formatDecimal(result.offerLifestyle.uberEatsOrders, 0, 0)}">0</div>
                    <div class="lifestyle-label">Uber Eats</div>
                </div>
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">‚úàÔ∏è</div>
                    <div class="lifestyle-value tabular-nums" th:text="${#numbers.formatDecimal(result.offerLifestyle.weekendGetaways, 1, 1)}">0</div>
                    <div class="lifestyle-label">Weekends</div>
                </div>
            </div>
        </section>

        <!-- 3-Year Asset Projection -->
        <section class="dream-section">
            <h2 class="section-title">3-Year Asset Projection</h2>
            <div class="asset-projection">
                <div class="projection-card">
                    <div class="projection-label">Current City</div>
                    <div class="projection-value tabular-nums" id="currentCityProjection"
                         th:attr="data-value=${result.current.residual * 36}"
                         th:text="${'$' + #numbers.formatDecimal(result.current.residual * 36, 1, 0)}">$0</div>
                    <div class="projection-subtitle" th:text="|${cityA.city} (36 months)|">City A (36 months)</div>
                </div>
                <div class="projection-card">
                    <div class="projection-label">New City</div>
                    <div class="projection-value tabular-nums" id="newCityProjection"
                         th:attr="data-value=${result.offer.residual * 36}"
                         th:text="${'$' + #numbers.formatDecimal(result.offer.residual * 36, 1, 0)}">$0</div>
                    <div class="projection-subtitle" th:text="|${cityB.city} (36 months)|">City B (36 months)</div>
                </div>
            </div>
        </section>

        <!-- Quick Compare -->
        <section class="compare-section">
            <h2 class="section-title">Quick Compare</h2>
            <div class="compare-card">
                <div class="input-group">
                    <label class="input-label">Compare <span th:text="${cityB.city}">City B</span> with:</label>
                    <select id="city-swap" class="minimal-select">
                        <option value="">Select a city...</option>
                        <option th:each="city : ${cities}"
                                th:value="${city.slug}"
                                th:text="|${city.city}, ${city.state}|"
                                th:disabled="${city.slug == cityB.slug}"></option>
                    </select>
                </div>
            </div>
        </section>
    </main>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Confetti Container -->
<div id="confettiContainer"></div>

<!-- Initialize Simulator with Server Data (BEFORE main.js) -->
<script th:inline="javascript">
    window.INITIAL_DATA = {
        currentResidual: /*[[${result.current.residual}]]*/ 0,
        offerResidual: /*[[${result.offer.residual}]]*/ 0,
        offerNetMonthly: /*[[${result.offer.netMonthly}]]*/ 0,
        offerRent: /*[[${result.offer.rent}]]*/ 0,
        offerLivingCost: /*[[${result.offer.livingCost}]]*/ 0,
        offerTransport: /*[[${result.offer.transport}]]*/ 0,
        offerGroceries: /*[[${result.offer.groceries}]]*/ 0,
        offerMisc: /*[[${result.offer.misc}]]*/ 0,
        deltaPercent: /*[[${result.deltaPercent}]]*/ 0,
        currentResidualAbs: /*[[${#numbers.formatDecimal(Math.abs(result.current.residual), 1, 0)}]]*/ 0,
        currentResidual: /*[[${result.current.residual}]]*/ 0,
        cityAAvgHousePrice: /*[[${cityA.avgHousePrice}]]*/ 0,
        cityBAvgHousePrice: /*[[${cityB.avgHousePrice}]]*/ 0,
        grossIncome: /*[[${result.offer.netMonthly * 12 / (1 - 0.0765)}]]*/ 0,
        taxes: /*[[${(result.offer.netMonthly * 12 / (1 - 0.0765)) - (result.offer.netMonthly * 12)}]]*/ 0,
        housingType: /*[[${housingType.name()}]]*/ 'RENT',
        householdType: /*[[${householdType.name()}]]*/ 'SINGLE'
    };
    console.log('INITIAL_DATA set:', window.INITIAL_DATA);
</script>

<script th:src="@{/js/main.js}"></script>
<script type="application/ld+json" th:utext="${structuredDataJson}"></script>
</body>
</html>
