<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="~{fragments/header :: head(${title}, ${metaDescription}, ${canonicalUrl}, ${ogTitle}, ${ogDescription}, ${ogUrl}, ${ogImageUrl})}"></head>
<body>
<div class="page-container">
    <!-- Top Header -->
    <header class="page-header">
        <div class="header-content">
            <a href="/" class="logo">OfferVerdict</a>
            <button class="btn-edit-inputs" id="editInputsBtn" aria-label="Edit inputs">
                <span>‚úèÔ∏è</span> Edit Inputs
            </button>
        </div>
    </header>

    <!-- Edit Inputs Accordion -->
    <div class="edit-panel" id="editPanel">
        <div class="edit-panel-content">
            <form th:action="@{/}" method="get">
                <input type="hidden" name="job" th:value="${job.slug}"/>
                <div class="edit-grid">
                    <div class="input-group">
                        <label class="input-label">Current salary</label>
                        <input type="number" name="currentSalary" class="minimal-input" min="1000" max="10000000" step="1" th:value="${currentSalary}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Offer salary</label>
                        <input type="number" name="offerSalary" class="minimal-input" min="1000" max="10000000" step="1" th:value="${offerSalary}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Current city</label>
                        <input name="cityA" class="minimal-input" list="city-options" th:value="${cityA.slug}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Offer city</label>
                        <input name="cityB" class="minimal-input" list="city-options" th:value="${cityB.slug}" required/>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Household</label>
                        <select name="householdType" class="minimal-select" th:value="${householdType}">
                            <option value="SINGLE" th:selected="${householdType.name() == 'SINGLE'}">Single</option>
                            <option value="FAMILY" th:selected="${householdType.name() == 'FAMILY'}">Family</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Housing</label>
                        <select name="housingType" class="minimal-select" th:value="${housingType}">
                            <option value="RENT" th:selected="${housingType.name() == 'RENT'}">Renting</option>
                            <option value="OWN" th:selected="${housingType.name() == 'OWN'}">Own home</option>
                            <option value="PARENTS" th:selected="${housingType.name() == 'PARENTS'}">Living with parents</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <button type="submit" class="btn btn-primary btn-full">Update verdict</button>
                    </div>
                </div>
            </form>
            <datalist id="city-options">
                <option th:each="city : ${cities}" th:value="${city.slug}" th:text="|${city.city}, ${city.state}|"></option>
            </datalist>
        </div>
    </div>

    <div th:if="${validationMessage}" class="validation-message">
        <strong>Check your numbers.</strong>
        <span th:text="${validationMessage}">Please enter a realistic salary.</span>
    </div>

    <!-- Mobile Sticky Header -->
    <div class="mobile-sticky-header" id="mobileSticky">
        <div class="verdict-mini" id="verdictMini" th:text="${result?.verdict ?: 'GO'}">GO</div>
        <div class="residual-mini" id="residualMini" th:text="${result?.offer?.residual != null ? ('$' + #numbers.formatDecimal(result.offer.residual, 1, 0)) : '$0'}">$0</div>
    </div>

    <!-- Split-View Dashboard Container -->
    <main class="dashboard-container">
        <!-- LEFT STICKY COLUMN: "Command Center" (40%) -->
        <div class="command-center">
        <!-- Hero Verdict Section -->
        <section class="verdict-hero" th:classappend="'verdict-' + ${result?.verdict?.name()?.toLowerCase()?.replace('_','-') ?: 'go'}" id="verdictHero">
            <div class="verdict-hero-content">
                <p class="verdict-route" th:text="|${cityA?.city ?: 'City A'}, ${cityA?.state ?: 'ST'} ‚Üí ${cityB?.city ?: 'City B'}, ${cityB?.state ?: 'ST'}|">Route</p>
                <h1 class="verdict-badge" id="verdictBadge" th:text="${result?.verdict ?: 'GO'}">GO</h1>
                <p class="verdict-copy" id="verdictCopy" th:text="${result?.verdictCopy ?: 'Calculating...'}">Punchy copy</p>
                
                <div class="verdict-metrics">
                    <div class="metric-item">
                        <div class="metric-label">Monthly Residual</div>
                        <div class="metric-value" id="heroResidualValue">
                            <span class="rolling-number tabular-nums" 
                                  th:attr="data-target=${result?.offer?.residual != null ? #numbers.formatDecimal(result.offer.residual, 1, 0) : 0}" 
                                  data-prefix="$"
                                  th:text="${result?.offer?.residual != null ? ('$' + #numbers.formatDecimal(result.offer.residual, 1, 0)) : '$0'}">$0</span>
                        </div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">vs Current</div>
                        <div class="metric-value">
                            <span class="rolling-number tabular-nums delta-percent" id="deltaPercentValue"
                                  th:attr="data-target=${result?.deltaPercent != null ? #numbers.formatDecimal(result.deltaPercent, 1, 1) : 0}"
                                  th:text="${result?.deltaPercent != null ? (#numbers.formatDecimal(result.deltaPercent, 1, 1) + '%') : '0%'}">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        </div>
        <!-- END Command Center -->

        <!-- RIGHT SCROLLABLE COLUMN: "Lab" (60%) -->
        <div class="lab-controls">
        <!-- Life Simulator Section -->
        <section class="simulator-section" id="lifeSimulator">
            <div class="section-header">
                <h2>üõ†Ô∏è Can I survive there?</h2>
                <p class="section-subtitle">Adjust your lifestyle scenarios and watch the numbers change in real-time</p>
            </div>

            <div class="simulator-controls">
                <!-- Housing Scenario -->
                <div class="control-group">
                    <label class="control-label">üè† Housing Scenario</label>
                    <div class="control-inputs">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="housingScenario" value="RENT" id="housingRent" checked/>
                                <span>üí∞ Renting (Default)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="housingScenario" value="OWN" id="housingOwn"/>
                                <span>üè° Own Home (No rent, but property tax/maintenance)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="housingScenario" value="PARENTS" id="housingParents"/>
                                <span>üë®‚Äçüë©‚Äçüë¶ Living with Parents ($0 rent, +$300 social cost)</span>
                            </label>
                        </div>
                        
                        <!-- Roommate Toggle -->
                        <div class="toggle-control" style="margin-top: 1rem;">
                            <label class="toggle-label">
                                <input type="checkbox" id="roommateToggle"/>
                                <span class="toggle-slider"></span>
                                <span class="toggle-text">üíë Split Rent with Partner/Roommate (-50%)</span>
                            </label>
                        </div>
                        
                        <!-- Rent Slider (only visible when RENT is selected) -->
                        <div class="slider-control" id="rentSliderGroup" style="margin-top: 1rem;">
                            <label>Adjust Monthly Rent</label>
                            <div class="slider-wrapper">
                                <input type="range" id="rentSlider" 
                                       th:attr="data-base=${result?.offer?.rent ?: 0}"
                                       min="0" max="10000" step="50" 
                                       th:value="${result?.offer?.rent ?: 0}"/>
                                <span class="slider-value" id="rentValue" th:text="${result?.offer?.rent != null ? ('$' + #numbers.formatDecimal(result.offer.rent, 1, 0)) : '$0'}">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transport Controls -->
                <div class="control-group">
                    <label class="control-label">üöó Transportation</label>
                    <div class="control-inputs">
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="transport" value="car" id="transportCar" checked/>
                                <span>üöó Car Owner (Default)</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="transport" value="transit" id="transportTransit"/>
                                <span>üöá Public Transit Only (Save on gas/insurance)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Dining Controls -->
                <div class="control-group">
                    <label class="control-label">üçΩÔ∏è Dining & Lifestyle</label>
                    <div class="control-inputs">
                        <div class="slider-control">
                            <label>Home Cook ‚Üî Foodie</label>
                            <div class="slider-wrapper">
                                <input type="range" id="diningSlider" min="0" max="100" step="5" value="50"/>
                                <span class="slider-value" id="diningValue">50%</span>
                            </div>
                            <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 0.5rem;">0% = Cook every meal | 100% = Eat out frequently</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Evidence Section: Waterfall Chart -->
        <section class="evidence-section">
            <h2 class="section-title">The Numbers</h2>
            <div class="waterfall-chart" id="waterfallChart">
                <div class="waterfall-item">
                    <div class="waterfall-label">Gross Income</div>
                    <div class="waterfall-bar waterfall-positive" id="waterfallGross" 
                         th:attr="data-value=${result?.offer?.netMonthly != null ? (result.offer.netMonthly * 12 / (1 - 0.0765)) : 0}"
                         style="height: 100%">
                        <span class="waterfall-value" id="waterfallGrossValue" 
                              th:text="${result?.offer?.netMonthly != null ? ('$' + #numbers.formatDecimal(result.offer.netMonthly * 12 / (1 - 0.0765), 1, 0)) : '$0'}">$0</span>
                    </div>
                </div>
                <div class="waterfall-item">
                    <div class="waterfall-label">(-) Taxes</div>
                    <div class="waterfall-bar waterfall-negative" id="waterfallTaxes"
                         th:attr="data-value=${result?.offer?.netMonthly != null ? ((result.offer.netMonthly * 12 / (1 - 0.0765)) - (result.offer.netMonthly * 12)) : 0}"
                         style="height: 0%">
                        <span class="waterfall-value" id="waterfallTaxesValue"
                              th:text="${result?.offer?.netMonthly != null ? ('$' + #numbers.formatDecimal((result.offer.netMonthly * 12 / (1 - 0.0765)) - (result.offer.netMonthly * 12), 1, 0)) : '$0'}">$0</span>
                    </div>
                </div>
                <div class="waterfall-item">
                    <div class="waterfall-label">(-) Housing</div>
                    <div class="waterfall-bar waterfall-negative" id="waterfallHousing"
                         th:attr="data-value=${result?.offer?.rent ?: 0}"
                         style="height: 0%">
                        <span class="waterfall-value" id="waterfallHousingValue"
                              th:text="${result?.offer?.rent != null ? ('$' + #numbers.formatDecimal(result.offer.rent, 1, 0)) : '$0'}">$0</span>
                    </div>
                </div>
                <div class="waterfall-item">
                    <div class="waterfall-label">(=) Residual</div>
                    <div class="waterfall-bar waterfall-positive" id="waterfallResidual"
                         th:attr="data-value=${result?.offer?.residual ?: 0}"
                         style="height: 0%">
                        <span class="waterfall-value" id="waterfallResidualValue"
                              th:text="${result?.offer?.residual != null ? ('$' + #numbers.formatDecimal(result.offer.residual, 1, 0)) : '$0'}">$0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ad Placeholder 1 (Between Housing and Lifestyle) -->
        <div class="ad-placeholder">
            üì¢ Ad Space (Hidden in Production)
        </div>

        <!-- Lifestyle Multiplier -->
        <section class="lifestyle-section">
            <h2 class="section-title">What that money really means</h2>
            <div class="lifestyle-scroll">
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">‚òï</div>
                    <div class="lifestyle-value tabular-nums" th:text="${result?.offerLifestyle?.starbucksCoffees != null ? #numbers.formatDecimal(result.offerLifestyle.starbucksCoffees, 0, 0) : 0}">0</div>
                    <div class="lifestyle-label">Starbucks</div>
                </div>
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">üì∫</div>
                    <div class="lifestyle-value tabular-nums" th:text="${result?.offerLifestyle?.netflixSubscriptions != null ? #numbers.formatDecimal(result.offerLifestyle.netflixSubscriptions, 0, 0) : 0}">0</div>
                    <div class="lifestyle-label">Netflix</div>
                </div>
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">üçî</div>
                    <div class="lifestyle-value tabular-nums" th:text="${result?.offerLifestyle?.uberEatsOrders != null ? #numbers.formatDecimal(result.offerLifestyle.uberEatsOrders, 0, 0) : 0}">0</div>
                    <div class="lifestyle-label">Uber Eats</div>
                </div>
                <div class="lifestyle-item">
                    <div class="lifestyle-icon">‚úàÔ∏è</div>
                    <div class="lifestyle-value tabular-nums" th:text="${result?.offerLifestyle?.weekendGetaways != null ? #numbers.formatDecimal(result.offerLifestyle.weekendGetaways, 1, 1) : 0}">0</div>
                    <div class="lifestyle-label">Weekends</div>
                </div>
            </div>
        </section>

        <!-- 3-Year Asset Projection - "The Race Track" -->
        <section class="dream-section">
            <h2 class="section-title">üèÅ 3-Year Asset Projection</h2>
            <div class="asset-projection">
                <!-- Current City Progress Bar -->
                <div class="projection-card">
                    <div class="projection-label" th:text="|${cityA?.city ?: 'City A'} - Current|">Current City</div>
                    <div class="projection-progress">
                        <div class="projection-progress-fill" id="currentCityProgress" style="width: 0%">
                            <div class="projection-value tabular-nums" id="currentCityProjection"
                                 th:attr="data-value=${result?.current?.residual != null ? (result.current.residual * 36) : 0}"
                                 th:text="${result?.current?.residual != null ? ('$' + #numbers.formatDecimal(result.current.residual * 36, 1, 0)) : '$0'}">$0</div>
                        </div>
                    </div>
                    <div class="projection-subtitle">36 months of saving</div>
                </div>
                
                <!-- New City Progress Bar -->
                <div class="projection-card">
                    <div class="projection-label" th:text="|${cityB?.city ?: 'City B'} - New Offer|">New City</div>
                    <div class="projection-progress">
                        <div class="projection-progress-fill" id="newCityProgress" style="width: 0%">
                            <div class="projection-value tabular-nums" id="newCityProjection"
                                 th:attr="data-value=${result?.offer?.residual != null ? (result.offer.residual * 36) : 0}"
                                 th:text="${result?.offer?.residual != null ? ('$' + #numbers.formatDecimal(result.offer.residual * 36, 1, 0)) : '$0'}">$0</div>
                        </div>
                    </div>
                    <div class="projection-subtitle">36 months of saving</div>
                </div>
            </div>
            
            <!-- Dynamic Dream Text -->
            <div class="dream-text" id="dreamText">
                <p>üí≠ At this rate, you're building wealth...</p>
            </div>
        </section>

        <!-- Quick Compare -->
        <section class="compare-section">
            <h2 class="section-title">Quick Compare</h2>
            <div class="compare-card">
                <div class="input-group">
                    <label class="input-label">Compare <span th:text="${cityB?.city ?: 'City B'}">City B</span> with:</label>
                    <select id="city-swap" class="minimal-select">
                        <option value="">Select a city...</option>
                        <option th:each="city : ${cities}"
                                th:value="${city?.slug ?: ''}"
                                th:text="|${city?.city ?: 'Unknown'}, ${city?.state ?: ''}|"
                                th:disabled="${city?.slug == cityB?.slug}"></option>
                    </select>
                </div>
            </div>
        </section>
        </div>
        <!-- END Lab Controls -->
    </main>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>

<!-- Confetti Container -->
<div id="confettiContainer"></div>

<!-- Initialize Simulator with Server Data (BEFORE main.js) -->
<script th:inline="javascript">
    window.INITIAL_DATA = {
        currentResidual: /*[[${result?.current?.residual ?: 0}]]*/ 0,
        offerResidual: /*[[${result?.offer?.residual ?: 0}]]*/ 0,
        offerNetMonthly: /*[[${result?.offer?.netMonthly ?: 0}]]*/ 0,
        offerRent: /*[[${result?.offer?.rent ?: 0}]]*/ 0,
        offerLivingCost: /*[[${result?.offer?.livingCost ?: 0}]]*/ 0,
        offerTransport: /*[[${result?.offer?.transport ?: 0}]]*/ 0,
        offerGroceries: /*[[${result?.offer?.groceries ?: 0}]]*/ 0,
        offerMisc: /*[[${result?.offer?.misc ?: 0}]]*/ 0,
        deltaPercent: /*[[${result?.deltaPercent ?: 0}]]*/ 0,
        currentResidualAbs: /*[[${result?.current?.residual != null ? #numbers.formatDecimal(T(java.lang.Math).abs(result.current.residual), 1, 0) : 0}]]*/ 0,
        currentResidual: /*[[${result?.current?.residual ?: 0}]]*/ 0,
        cityAAvgHousePrice: /*[[${cityA?.avgHousePrice ?: 0}]]*/ 0,
        cityBAvgHousePrice: /*[[${cityB?.avgHousePrice ?: 0}]]*/ 0,
        grossIncome: /*[[${offerTaxBreakdown?.grossIncome ?: 0}]]*/ 0,
        taxes: /*[[${offerTaxBreakdown?.totalTax ?: 0}]]*/ 0,
        housingType: /*[[${housingType?.name() ?: 'RENT'}]]*/ 'RENT',
        householdType: /*[[${householdType?.name() ?: 'SINGLE'}]]*/ 'SINGLE',
        // Tax Breakdown for Precision
        taxBreakdown: {
            federal: /*[[${offerTaxBreakdown?.federalTax ?: 0}]]*/ 0,
            state: /*[[${offerTaxBreakdown?.stateTax ?: 0}]]*/ 0,
            socialSecurity: /*[[${offerTaxBreakdown?.socialSecurityTax ?: 0}]]*/ 0,
            medicare: /*[[${offerTaxBreakdown?.medicareTax ?: 0}]]*/ 0,
            additionalMedicare: /*[[${offerTaxBreakdown?.additionalMedicareTax ?: 0}]]*/ 0
        },
        offerSalary: /*[[${offerSalary ?: 0}]]*/ 0,
        cityAName: /*[[${cityA?.city ?: 'City A'}]]*/ 'City A',
        cityBName: /*[[${cityB?.city ?: 'City B'}]]*/ 'City B'
    };
    console.log('[INITIAL_DATA] Precision data loaded:', window.INITIAL_DATA);
</script>

<script th:src="@{/js/main.js}"></script>
<script type="application/ld+json" th:utext="${structuredDataJson}"></script>
</body>
</html>
